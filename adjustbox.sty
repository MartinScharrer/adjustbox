%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsection{Package header, options and dependencies}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    \begin{macrocode}
\ProvidesPackage{adjustbox}[2011/03/20 v0.3 Adjusting TeX boxes (trim, clip, ...)]
%    \end{macrocode}
%
%    \begin{macrocode}
\RequirePackage{xkeyval}
%\def\adjbox@dim@pgfmath{\AtEndOfPackage{\RequirePackage{pgfrcs,pgfkeys,pgfmath}\adjbox@dim@pgfmath}}
\def\adjbox@dim@pgfmath{\AtEndOfPackage{\RequirePackage{pgf}\adjbox@dim@pgfmath}}
\def\adjbox@dim@etex{\AtEndOfPackage{\adjbox@dim@etex}}
\def\adjbox@dim@tex{\AtEndOfPackage{\adjbox@dim@tex}}
\def\adjbox@dim@latex{\AtEndOfPackage{\adjbox@dim@latex}}
\def\adjbox@dim@calc{\AtEndOfPackage{\RequirePackage{calc}\adjbox@dim@calc}}

%%  * Default unit: pt, bp, any other unit, none
\def\adjbox@defaultunit{bp}
\DeclareOptionX<adjbox>{defaultunit}{\def\adjbox@defaultunit{#1}}

%%  * Math for Dimensions: etex, tex, latex, pgfmath
\DeclareOptionX<adjbox>{PGF}{\def\adjbox@driver{adjpgf.def}\adjbox@dim@pgfmath}
\DeclareOptionX<adjbox>{pgfmath}{\adjbox@dim@pgfmath}
\DeclareOptionX<adjbox>{etex}{\adjbox@dim@etex}
\DeclareOptionX<adjbox>{tex}{\adjbox@dim@tex}
\DeclareOptionX<adjbox>{latex}{\adjbox@dim@latex}
\DeclareOptionX<adjbox>{calc}{\adjbox@dim@calc}

\def\adjbox@fam{adjbox}
\DeclareOptionX<adjbox>{export}{\def\adjbox@fam{Gin}}
\DeclareOptionX<adjbox>{patch}{\AtEndOfPackage{\RequirePackage{adjgrfx}}}

%%  * Driver (pdftex, all others => PGF) DONE!
\def\adjbox@driver{adj\Gin@driver}
\DeclareOptionX<adjbox>{pgf}{\def\adjbox@driver{adjpgf.def}}
\DeclareOptionX<adjbox>*{\PassOptionsToPackage\CurrentOption{graphicx}}

%% Options:
%%  * Install keys: for adjustbox only only also for \includegraphics

%% Process Options:
\ProcessOptionsX*<adjbox>
\disable@keys{adjbox}{patch,export,PGF}
%    \end{macrocode}
%
%    \begin{macrocode}
\RequirePackage{graphicx}[1999/02/16]
\RequirePackage{collectbox}
%    \end{macrocode}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsection{Basic commands}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \begin{macro}{\adjbox@viewport}
%    \begin{macrocode}
\define@key{adjbox}{viewport}{%
    \let\Gin@viewport@code\adjbox@@viewport
    \let\adjustbox@@@\adjustbox@@@trimclip
    \adjbox@parse@v#1 \\%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@trim}
%    \begin{macrocode}
\define@key{adjbox}{trim}{%
    \let\Gin@viewport@code\adjbox@@trim
    \let\adjustbox@@@\adjustbox@@@trimclip
    \adjbox@parse@v#1 \\%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjustbox@@@trimclip}
%    \begin{macrocode}
\def\adjustbox@@@trimclip{%
    \Gin@viewport@code
    \ifGin@clip
        \expandafter\@clipbox
    \else
        \expandafter\@trimbox
    \fi
        \adjbox@tllx
        \adjbox@tlly
        \adjbox@turx
        \adjbox@tury
        \collectedbox
    \usebox\collectedbox
}
%    \end{macrocode}
% \end{macro}
%
%
%
% \begin{macro}{\adjbox@parse@v}
%    \begin{macrocode}
\def\adjbox@parse@v#1 #2 #3 #4 #5\\{%
  \adjbox@default\adjbox@tllx{#1}%
  \adjbox@default\adjbox@tlly{#2}%
  \adjbox@default\adjbox@turx{#3}%
  \adjbox@default\adjbox@tury{#4}%
}%
%%\newdimen\adjbox@llx
%%\newdimen\adjbox@lly
%%\newdimen\adjbox@urx
%%\newdimen\adjbox@ury
\newdimen\adjbox@tllx
\newdimen\adjbox@tlly
\newdimen\adjbox@turx
\newdimen\adjbox@tury
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@default}
%    \begin{macrocode}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@@trim}
%    \begin{macrocode}
\let\adjbox@@trim\relax
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@@viewport}
%    \begin{macrocode}
\def\adjbox@@viewport{%
    %\advance\adjbox@tllx by -\z@
    \advance\adjbox@tlly by  \dp\collectedbox
    \advance\adjbox@turx by -\wd\collectedbox
    \advance\adjbox@tury by -\ht\collectedbox
    \adjbox@turx=-\adjbox@turx
    \adjbox@tury=-\adjbox@tury
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\trimbox}
%    \begin{macrocode}
\newcommand\trimbox{%
    \@ifstar
        {\collectboxcheckenv{trimbox*}\trimbox@s}%
        {\collectboxcheckenv{trimbox}\trimbox@}%
}
\def\trimbox@#1{%
    \collectbox{\trimbox@@{#1}}%
}
\def\trimbox@s#1{%
    \collectbox{\viewport@@{#1}}%
}
\def\trimbox@@#1{%
    \adjbox@parse@v#1 \\%
    \@trimbox
        \adjbox@tllx
        \adjbox@tlly
        \adjbox@turx
        \adjbox@tury
        \collectedbox
    \usebox\collectedbox
}
\def\viewport@@#1{%
    \adjbox@parse@v#1 \\%
    \adjbox@@viewport
    \@trimbox
        \adjbox@tllx
        \adjbox@tlly
        \adjbox@turx
        \adjbox@tury
        \collectedbox
    \usebox\collectedbox
}
%    \end{macrocode}
% \end{macro}
%
% \begin{environment}{trimbox*}
%    \begin{macrocode}
\expandafter\let\csname trimbox*\endcsname\trimbox@s
%    \end{macrocode}
% \end{environment}
%
% \begin{key}\adjbox@fam{Trim}
%    \begin{macrocode}
\define@key\adjbox@fam{Trim}{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@Gin@add{\trimbox@{#1}}%
}
%    \end{macrocode}
% \end{key}
%
% \begin{key}\adjbox@fam{Viewport}
%    \begin{macrocode}
\define@key\adjbox@fam{Viewport}{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@Gin@add{\viewport@{#1}}%
}
%    \end{macrocode}
% \end{key}
%
% \begin{key}\adjbox@fam{Clip}
%    \begin{macrocode}
\define@key\adjbox@fam{Clip}{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@Gin@add{\clipbox@{#1}}%
}
%    \end{macrocode}
% \end{key}
%
% \begin{key}\adjbox@fam{Clip*}
%    \begin{macrocode}
\define@key\adjbox@fam{Clip*}{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@Gin@add{\clipviewport@{#1}}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{macro}{\clipbox}
%    \begin{macrocode}
\newcommand\clipbox{%
    \@ifstar
        {\collectboxcheckenv{clipbox*}\clipbox@s}%
        {\collectboxcheckenv{clipbox}\clipbox@}%
}
\def\clipbox@#1{%
    \collectbox{\clipbox@@{#1}}%
}
\def\clipbox@s#1{%
    \collectbox{\clipviewport@@{#1}}%
}
\def\clipbox@@#1{%
    \adjbox@parse@v#1 \\%
    \@clipbox
        \adjbox@tllx
        \adjbox@tlly
        \adjbox@turx
        \adjbox@tury
        \collectedbox
    \usebox\collectedbox
}
\def\clipviewport@@#1{%
    \adjbox@parse@v#1 \\%
    \adjbox@@viewport
    \@clipbox
        \adjbox@tllx
        \adjbox@tlly
        \adjbox@turx
        \adjbox@tury
        \collectedbox
    \usebox\collectedbox
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{environment}{clipbox*}
%    \begin{macrocode}
\expandafter\let\csname clipbox*\endcsname\clipbox@s
%    \end{macrocode}
% \end{environment}
%
%
% \begin{macro}{\adjustbox}
%    \begin{macrocode}
\newcommand\adjustbox[1]{%
    \collectboxcheckenv{adjustbox}%
    \collectbox{\adjustbox@{#1}}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjustbox@}
% This code was adapted from the \Macro\Gin@ii macro from the |graphicx| package.
% The \emph{temp switch a} is set to |true| to indicate to |graphicx| that the
% scaling should be done internal, so this package doesn't have to do it.
% The content including macro \Macro\adjustbox@@@ is but into place,
% the saved options are activated and the final size is set.
% The typesetting of the content is finally done by executing the token register.
%    \begin{macrocode}
\def\adjustbox@#1{%
    \adjustbox@dimcmds
    \let\Gin@esetsize\adjbox@esetsize
    \@tempswafalse
    \toks@{{\adjustbox@@@@}}%
    \def\setlength{\adjbox@setdim}%
    \setkeys{adjbox,Gin}{#1}%
    \adjbox@esetsize
    \the\toks@
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjustbox@@@@}
% Content wrapper which might be redefined when the size is specified.
%    \begin{macrocode}
\def\adjustbox@@@@{\adjustbox@@@}%
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@esetsize}
% Replacement of \Macro\Gin@esetsize.
% When called in \emph{external} mode (switch is true) then the content is wrapped in
% the internal form of \Macro\resizebox. In \emph{internal} mode, i.e.\ resizing is done by the graphic driver,
% the same code is added around the inner macro. This ensures the same behaviour as \Macro\includegraphics.
%    \begin{macrocode}
\def\adjbox@esetsize{%
  \if@tempswa
    \edef\@tempa{\toks@{\noexpand
             \Gscale@@box\noexpand\Gin@eresize
              {\Gin@ewidth}{\Gin@eheight}{\the\toks@}}}%
    \@tempa
  \else
    \edef\adjustbox@@@@{\noexpand
             \Gscale@@box\noexpand\Gin@eresize
              {\Gin@ewidth}{\Gin@eheight}{\noexpand\adjustbox@@@}}%
  \fi
  \let\Gin@ewidth\Gin@exclamation
  \let\Gin@eheight\Gin@exclamation
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjustbox@dimcmds}
%    \begin{macrocode}
\def\adjustbox@dimcmds{%
    \protected\edef\WIDTH {\dimexpr\the\wd\collectedbox\relax}%
    \protected\edef\HEIGHT{\dimexpr\the\ht\collectedbox\relax}%
    \protected\edef\DEPTH {\dimexpr\the\dp\collectedbox\relax}%
    \protected\edef\TOTALHEIGHT{\dimexpr\the\ht\collectedbox+\the\dp\collectedbox\relax}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjustbox@@@}
%    \begin{macrocode}
\def\adjustbox@@@{%
    \usebox\collectedbox
}
%    \end{macrocode}
% \end{macro}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsubsection{Low-level trim and clip boxes}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \begin{macro}{\@trimbox}
%    \begin{macrocode}
\def\@trimbox#1#2#3#4#5{%
    \setbox#5=\hbox{%
        \adjbox@setdim\@tempdima{#1}%
        \hskip-\@tempdima
        \adjbox@setsubdim{\@tempdima}{\dp#5}{#2}%
        \adjbox@setsubdim{\@tempdimb}{\wd#5}{#3}%
        \adjbox@setsubdim{\@tempdimc}{\ht#5}{#4}%
        \dp#5=\@tempdima
        \wd#5=\@tempdimb
        \ht#5=\@tempdimc
        \ifdim\dp#5<\z@
            \raise\dp#5%
        \else
        \ifdim\ht#5<\z@
            \lower\ht#5%
        \fi\fi
        \box#5%
    }%
    \ifdim\dp#5<\z@ \dp#5=\z@ \fi
    \ifdim\wd#5<\z@ \wd#5=\z@ \fi
    \ifdim\ht#5<\z@ \ht#5=\z@ \fi
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@clipbox}
%    \begin{macrocode}
\def\@clipbox#1#2#3#4#5{%
    \@trimbox{#1}{#2}{#3}{#4}{#5}%
    \pdfxform#5%
    \setbox#5=\hbox{%
        \pdfrefxform\pdflastxform
    }%
}
%    \end{macrocode}
% \end{macro}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsection{Driver}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% The clipping support is output driver dependent. The driver selected by \pkg{graphics} is used and a definition file
% is used if its exists. Otherwise either the default \texttt{pdftex} implementation or the \pkg{pgf} fall-back driver
% is used.
%    \begin{macrocode}
\RequirePackage{ifpdf}
\InputIfFileExists{\adjbox@driver}{%
    \PackageInfo{adjustbox}{Using driver '\adjbox@driver'.}%
}{%
    \ifpdf
        \PackageInfo{adjustbox}{Using default pdftex driver.}
    \else
        \input{adjpgf.def}%
        \PackageInfo{adjustbox}{Using fall-back PGF driver.}
    \fi
}
%    \end{macrocode}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsection{More box commands}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \begin{macro}{\minsizebox}
%    \begin{macrocode}
\newcommand*\minsizebox{%
    \@ifstar{\@minsizebox\totalheight}{\@minsizebox\height}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@minsizebox}
%    \begin{macrocode}
\newcommand*\@minsizebox[3]{%
    \@collectbox{\@minmaxsizebox>#1{#2}{#3}}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\maxsizebox}
%    \begin{macrocode}
\newcommand*\maxsizebox{%
    \@ifstar{\@maxsizebox\totalheight}{\@maxsizebox\height}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@maxsizebox}
%    \begin{macrocode}
\newcommand*\@maxsizebox[3]{%
    \@collectbox{\@minmaxsizebox<#1{#2}{#3}}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@minmaxsizebox}
%    \begin{macrocode}
\newcommand*\@minmaxsizebox[4]{%
    \edef\@tempa{#3}% width
    \edef\@tempb{#4}% height
    \message{^^J [\@tempa,\@tempb] }%
    \ifcase0%
    \ifx\@tempa\Gin@exclamation
        \ifx\@tempb\Gin@exclamation\else
            \ifdim\@tempb#1#2%
                1%
            \fi
        \fi
    \else
        \ifx\@tempb\Gin@exclamation
            \ifdim\@tempa#1\width
                2%
            \fi
        \else
            \ifdim\@tempa#1\width
                \ifdim\@tempb#1#2%
                    3%
                \else
                    2%
                \fi
            \else
                \ifdim\@tempb#1#2%
                    1%
                \fi
            \fi
        \fi
    \fi
    \relax% 0
        \BOXCONTENT
    \or% 1
        \adjbox@setdim\@tempdima\@tempb
        \Gscale@div\@tempa\@tempdima#2%
        \Gscale@box\@tempa[\@tempa]\BOXCONTENT
    \or% 2
        \adjbox@setdim\@tempdima\@tempa
        \Gscale@div\@tempa\@tempdima\width%
        \Gscale@box\@tempa[\@tempa]\BOXCONTENT
    \or% 3
        \adjbox@setdim\@tempdima\@tempa
        \Gscale@div\@tempa\@tempdima\width
        \adjbox@setldim\@tempdima\@tempb
        \Gscale@div\@tempb\@tempdima#2%
        \ifdim\@tempa\p@#1\@tempb\p@
            \let\@tempb\@tempa
        \else
            \let\@tempa\@tempb
        \fi
        \Gscale@box\@tempa[\@tempb]\BOXCONTENT
    \fi
}
%    \end{macrocode}
% \end{macro}
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsection{New \cs{includegraphics} and \cs{adjustbox} options}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
% \begin{key}\adjbox@fam{frame}
%    \begin{macrocode}
\define@key\adjbox@fam{frame}[{{\fboxrule}}]{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@frame#1 {\z@} \relax\relax\@nnil
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{macro}{\adjbox@frame}
%    \begin{macrocode}
\def\adjbox@frame#1 #2 #3\relax{%
    \adjbox@Gin@add{%
        \adjbox@setdim\fboxrule{#1}%
        \adjbox@setdim\fboxsep{#2}%
        \fbox
    }%
    \adjbox@Gin@add{}% add group around code
    \remove@to@nnil
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{key}\adjbox@fam{reflect}
%    \begin{macrocode}
\define@key\adjbox@fam{reflect}[]{%
  \if@tempswa
    \adjbox@Gin@add{\Gscale@box-1[1]}%
  \else
    \def\Gin@req@sizes{%
      \def\Gin@scalex{-1}\def\Gin@scaley{1}%
      \Gin@req@height\Gin@nat@height
      \Gin@req@width\Gin@nat@width
    }%
  \fi
  \@tempswatrue}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{lap}
%    \begin{macrocode}
\define@key\adjbox@fam{lap}{%
    \Gin@esetsize
    \@tempswatrue
    \@ifnextchar\bgroup{%
        \adjbox@lapbox
    }{%
        \adjbox@lapbox{#1}{}%
    }#1{}{}\@nnil
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{macro}{\adjbox@lapbox}
%    \begin{macrocode}
\def\adjbox@lapbox#1#2#3\@nnil{%
    \ifx\relax#2\relax
        \adjbox@Gin@add{\@lapbox{}{#1}}%
    \else
        \adjbox@Gin@add{\i@lapbox{#1}{#2}}%
    \fi
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{key}\adjbox@fam{margin}
%    \begin{macrocode}
\define@key\adjbox@fam{margin}{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@Gin@add{\marginbox{#1}}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{dpi}
%    \begin{macrocode}
\define@key\adjbox@fam{dpi}{%
    \adjbox@setdim\pdfpxdimen{1in/(#1)}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{pxdim}
%    \begin{macrocode}
\define@key\adjbox@fam{pxdim}{%
    \adjbox@setdim\pdfpxdimen{#1}%
}
%    \end{macrocode}
% \end{key}
%
%
%    \begin{macrocode}
\define@key\adjbox@fam{show}{%
    \show#1%
}
\define@key{Gin}{debug}[]{%
    \showthe\toks@
}
\define@key\adjbox@fam{showthe}{%
    \showthe#1%
}
%    \end{macrocode}
%
%
% \begin{key}\adjbox@fam{raise}
%    \begin{macrocode}
\define@key\adjbox@fam{raise}{%
    \Gin@esetsize
    \@tempswatrue
    \@ifnextchar\bgroup{%
        \adjbox@raisebox
    }{%
        \adjbox@raisebox{#1}{}{}%
    }#1{}{}{}\@nnil
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{valign}
%    \begin{macrocode}
\define@key\adjbox@fam{valign}{%
    \csname adjbox@valign@#1\endcsname
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{macro}{\adjbox@valign@t}
%    \begin{macrocode}
\def\adjbox@valign@t{%
    \adjbox@Gin@Add{\@irsbox{\dimexpr-\height+\ht\strutbox\relax}[]}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@valign@T}
%    \begin{macrocode}
\def\adjbox@valign@T{%
    \adjbox@Gin@Add{\@irsbox{-\height}[]}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@valign@M}
%    \begin{macrocode}
\def\adjbox@valign@M{%
    \adjbox@Gin@Add{\@irsbox{\dimexpr.5\depth-.5\height\relax}[]}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@valign@m}
%    \begin{macrocode}
\def\adjbox@valign@m{%
    \adjbox@Gin@Add{\@irsbox{\dimexpr.5\depth-.5\height+.5\ht\strutbox\relax}[]}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@valign@b}
%    \begin{macrocode}
\def\adjbox@valign@b{%
    \adjbox@Gin@Add{\@irsbox{-\depth}[]}%
}
%    \end{macrocode}
% \end{macro}
%
%    \begin{macrocode}
\let\adjbox@valign@B\adjbox@valign@b
%    \end{macrocode}
%
% \begin{macro}{\adjbox@raisebox}
%    \begin{macrocode}
\def\adjbox@raisebox#1#2#3#4\@nnil{%
    \ifx\relax#3\relax
        \adjbox@Gin@add{\@irsbox{#1}[{#2}]}%
    \else
        \adjbox@Gin@add{\@iirsbox{#1}[{#2}][{#3}]}%
    \fi
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{key}\adjbox@fam{set height}
%    \begin{macrocode}
\define@key\adjbox@fam{set height}{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@Gin@add{\@irsbox\z@[{#1}]}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{set depth}
%    \begin{macrocode}
\define@key\adjbox@fam{set depth}{%
    \adjbox@Gin@add{\@iirsbox\z@[\height][{#1}]}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{macro}{\adjbox@Gin@add}
%    \begin{macrocode}
\def\adjbox@Gin@add#1{%
    \def\@tempa{#1}%
    \toks@\expandafter\expandafter\expandafter{\expandafter\@tempa\expandafter{\the\toks@}}%
}
\def\adjbox@Gin@Add{%
    \Gin@esetsize
    \@tempswatrue
    \adjbox@Gin@add
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@Gin@sizeadd}
% Checks if key-value is actually two arguments. If not it is doubled.
% E.g.: \verb+min size=\A+ is the same as  \verb+min size={\A}{\A}+
%    \begin{macrocode}
\def\adjbox@Gin@sizeadd#1#2#3\relax{%
    \ifx\relax#3\relax
        \adjbox@Gin@add{#1{#2}{#2}}%
    \else
        \adjbox@Gin@add{#1{#2}{#3}}%
    \fi
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{key}\adjbox@fam{min width}
%    \begin{macrocode}
\define@key\adjbox@fam{min width}{%
    \adjbox@Gin@Add{\@minsizebox\height{#1}!}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{max width}
%    \begin{macrocode}
\define@key\adjbox@fam{max width}{%
    \adjbox@Gin@Add{\@maxsizebox\height{#1}!}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{min height}
%    \begin{macrocode}
\define@key\adjbox@fam{min height}{%
    \adjbox@Gin@Add{\@minsizebox\height!{#1}}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{max height}
%    \begin{macrocode}
\define@key\adjbox@fam{max height}{%
    \adjbox@Gin@Add{\@maxsizebox\height!{#1}}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{min totalheight}
%    \begin{macrocode}
\define@key\adjbox@fam{min totalheight}{%
    \adjbox@Gin@Add{\@minsizebox\totalheight!{#1}}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{max totalheight}
%    \begin{macrocode}
\define@key\adjbox@fam{max totalheight}{%
    \adjbox@Gin@Add{\@maxsizebox\totalheight!{#1}}%
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{min size}
%    \begin{macrocode}
\define@key\adjbox@fam{min size}{%
    \adjbox@Gin@sizeadd{\@minsizebox\height}#1\relax
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{max size}
%    \begin{macrocode}
\define@key\adjbox@fam{max size}{%
    \adjbox@Gin@sizeadd{\@maxsizebox\height}#1\relax
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{min totalsize}
%    \begin{macrocode}
\define@key\adjbox@fam{min totalsize}{%
    \adjbox@Gin@sizeadd{\@minsizebox\totalheight}#1\relax
}
%    \end{macrocode}
% \end{key}
%
%
% \begin{key}\adjbox@fam{max totalsize}
%    \begin{macrocode}
\define@key\adjbox@fam{max totalsize}{%
    \adjbox@Gin@sizeadd{\@maxsizebox\totalheight}#1\relax
}
%    \end{macrocode}
% \end{key}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsubsection{Lap box}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \begin{macro}{\lapbox}
%    \begin{macrocode}
\newcommand*{\lapbox}[1][]{%
    \ifx\relax#1\relax
        \expandafter\@lapbox
    \else
        \expandafter\i@lapbox
    \fi
    {#1}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@lapbox}
%    \begin{macrocode}
\def\@lapbox#1#2{%
    \@collectbox{\@@lapbox{#2}}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@@lapbox}
%    \begin{macrocode}
\def\@@lapbox#1{%
    \adjbox@setdim\@tempdima{#1}%
    \@tempdimb\width
    \advance\@tempdimb by \ifdim\@tempdima>\z@-\fi\@tempdima
    \hb@xt@\@tempdimb{%
        \ifdim\@tempdima<\z@
            \hss
        \fi
        \BOXCONTENT
        \ifdim\@tempdima>\z@
            \hss
        \fi
    }%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\i@lapbox}
%    \begin{macrocode}
\def\i@lapbox#1#2{%
    \@collectbox{\i@@lapbox{#1}{#2}}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\i@@lapbox}
%    \begin{macrocode}
\def\i@@lapbox#1#2{%
    \adjbox@setdim\@tempdima{#2}%
    \adjbox@setdim\@tempdimb{#1}%
    \hb@xt@\@tempdimb{%
        \ifdim\@tempdima<\z@
            \hss
            \hb@xt@-\@tempdima{\BOXCONTENT\hss}%
            \hskip\@tempdimb
        \else
            \hskip\@tempdimb
            \hb@xt@\@tempdima{\hss\BOXCONTENT}%
            \hss
        \fi
    }%
}
%    \end{macrocode}
% \end{macro}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsubsection{Margin box}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \begin{macro}{\marginbox}[1]{Margins as space separated values (like for 'trim')}
% Collect box first.
%    \begin{macrocode}
\newcommand\marginbox[1]{%
    \@collectbox{\marginbox@{#1}}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\marginbox@}
% (1) Parse margins (must be done here to allow the user to use the original box dimensions).
% (2) Change box margins and (3) place the box.
%    \begin{macrocode}
\def\marginbox@#1{%
    \adjbox@parse@v#1 \\%
    \@marginbox
        \adjbox@tllx
        \adjbox@tlly
        \adjbox@turx
        \adjbox@tury
        \collectedbox
    \usebox\collectedbox
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@marginbox}
% Adds the given margins to the depth, width and height.
% The left margin is created by an horizontal skip.
% This implementation assumes that the margins are positive and no special checks are added.
% While negative margins will trim some margin off, this will not lead to correct results if this amounts
% are larger than the existing dimensions. For this the \Macro\trimbox macro should be used.
%    \begin{macrocode}
\def\@marginbox#1#2#3#4#5{%
    \setbox#5=\hbox{%
        \adjbox@setdim\@tempdima{#1}%
        \hskip\@tempdima
        \adjbox@setadddim{\@tempdima}{\dp#5}{#2}%
        \adjbox@setadddim{\@tempdimb}{\wd#5}{#3}%
        \adjbox@setadddim{\@tempdimc}{\ht#5}{#4}%
        \dp#5=\@tempdima
        \wd#5=\@tempdimb
        \ht#5=\@tempdimc
        \box#5%
    }%
}
%    \end{macrocode}
% \end{macro}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsection{Dimension macros}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% \begin{macro}{\adjbox@dim@etex}
%    \begin{macrocode}
\def\adjbox@dim@etex{%
    \def\adjbox@setdim##1##2{%
        ##1=\dimexpr##2\relax
    }%
    \def\adjbox@setadddim##1##2##3{%
        ##1=\dimexpr##2 + ##3\relax
    }%
    \def\adjbox@setsubdim##1##2##3{%
        ##1=\dimexpr##2 -\dimexpr##3\relax\relax
    }%
    \def\adjbox@default##1##2{%
        \@defaultunits##1=\dimexpr##2 \adjbox@defaultunit\relax\@nnil
    }%
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\adjbox@dim@tex}
%    \begin{macrocode}
\def\adjbox@dim@tex{%
    \def\adjbox@setdim##1##2{%
        ##1=##2\relax
    }%
    \def\adjbox@setadddim##1##2##3{%
        \@tempdima=##2\relax
        \advance\@tempdima by ##2\relax
        ##1=\@tempdima
    }%
    \def\adjbox@setsubdim##1##2##3{%
        \@tempdima=##2\relax
        \advance\@tempdima by -##2\relax
        ##1=\@tempdima
    }%
    \def\adjbox@default##1##2{%
        \@defaultunits##1=##2 \adjbox@defaultunit\relax\@nnil
    }%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@dim@latex}
%    \begin{macrocode}
\def\adjbox@dim@latex{%
    \def\adjbox@setdim{%
        \adjbox@origsetlength
    }%
    \def\adjbox@setadddim##1##2##3{%
        \adjbox@origsetlength\@tempdima{##2}%
        \addtolength\@tempdima{##3}%
        \adjbox@origsetlength##1{\@tempdima}%
    }%
    \def\adjbox@setsubdim##1##2##3{%
        \adjbox@origsetlength\@tempdima{##2}%
        \@tempdima=-\@tempdima
        \addtolength\@tempdima{##3}%
        \adjbox@origsetlength##1{-\@tempdima}%
    }%
    \def\adjbox@default##1##2{%
        \afterassignment\adjbox@checkdefault
        ##1=##2 \adjbox@defaultunit\relax\@nnil{##1}{##2}%
    }%
    \def\adjbox@checkdefault##1\@nnil##2##3{%
        \ifx\relax##1\relax\else
            \adjbox@origsetlength{##2}{##3}%
        \fi
    }%
}
\let\adjbox@dim@calc\adjbox@dim@latex
\AtEndOfPackage{\let\adjbox@origsetlength\setlength}
\AtBeginDocument{\let\adjbox@origsetlength\setlength}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\adjbox@dim@pgfmath}
%    \begin{macrocode}
\def\adjbox@dim@pgfmath{%
    \def\adjbox@setdim{%
        \pgfmathsetlength
    }%
    \def\adjbox@setadddim##1##2##3{%
        \pgfmathsetlength\@tempdima{##2 + ##3}%
        ##1=\@tempdima
    }%
    \def\adjbox@setsubdim##1##2##3{%
        \pgfmathsetlength\@tempdima{##2 - (##3)}%
        ##1=\@tempdima
    }%
    \def\adjbox@default##1##2{%
        \edef\pgfmathresultunitscale{1\adjbox@defaultunit}%
        \let\pgfmathpostparse\pgfmathscaleresult
        \pgfmathparse{##2}%
        ##1=\pgfmathresult pt\relax
    }%
}
%    \end{macrocode}
% \end{macro}
%
% Use e-TeX by default if available, otherwise LaTeX (maybe with \pkg{calc})
%    \begin{macrocode}
\begingroup
\expandafter\ifx\csname eTeXversion\endcsname\relax
    \endgroup
    \adjbox@dim@latex
    \def\adjbox@dim@etex{\PackageError{adjustbox}{e-TeX not available for current compiler!}}%
\else
    \endgroup
    \adjbox@dim@etex
\fi
%    \end{macrocode}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
