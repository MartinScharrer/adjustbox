%    \begin{macrocode}
\ProvidesPackage{storebox}[2011/08/05 v0.99 Store and reuse boxes in a file size efficient way]
\DeclareOption{disable}{\let\ifstorebox\iffalse}
\DeclareOption{enable}{\let\ifstorebox\iftrue}
\ProcessOptions*
\edef\@tempa{\@ptionlist{\@currname.\@currext}}
\ifx\@tempa\empty
    \RequirePackage{ifpdf}
    \expandafter\let\csname ifstorebox\expandafter\endcsname\csname ifpdf\endcsname
\fi
%    \end{macrocode}
%
%    \begin{macrocode}
\RequirePackage{collectbox}[2011/08/04]
%    \end{macrocode}
%
% \begin{macro}{\storebox}
%    \begin{macrocode}
\newcommand*\storebox{%
    \collectboxcheckenv{storebox}%
    \ifcollectboxenv
        \endgroup
        \expandafter\@storebox@env
    \else
        \expandafter\@storebox
    \fi
}
%    \end{macrocode}
% \end{macro}
%
%
%    \begin{macrocode}
\ifstorebox
%    \end{macrocode}
%
% \begin{macro}{\@storebox}
% Macro version:
%    \begin{macrocode}
\def\@storebox#1{%
    \begingroup
    \@collectboxto\collectedbox{\pdfxform\collectedbox\endgroup\mathchardef#1=\pdflastxform}%
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@storebox@env}
% Environment version. Code adapted from \env{lrbox} environment. The group added by \Macro\begin and \Macro\end must
% be specially handled to allow for a local assignment.
%    \begin{macrocode}
\def\@storebox@env#1{%
    \edef\@tempa{%
        \setbox\collectedbox\hbox\bgroup%
            \def\noexpand\@tempa{\noexpand#1}%
    }%
    \@tempa
    \begingroup
    \aftergroup\@storebox@env@end
    \@endpefalse
    \color@setgroup
    \begingroup
    \def\@currenvir{storebox\empty}%
    \ignorespaces
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@storebox@env@end}
% This ends the box assignment and stores the box as PDF xform.
% Then the given control sequence is set to the xform number.
%    \begin{macrocode}
\def\@storebox@env@end{%
    \edef\@tempa{%
        \egroup
        \pdfxform\collectedbox
        \endgroup
        \mathchardef\expandafter\noexpand\@tempa=\pdflastxform
    }%
    \@tempa
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\endstorebox}
%    \begin{macrocode}
\def\endstorebox{%
    \unskip
    \endgroup
    \color@endgroup
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\newstorebox}
%    \begin{macrocode}
\newcommand*\newstorebox[1]{%
    \@ifdefinable{#1}{\let#1\relax}%
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\usestorebox}
%    \begin{macrocode}
\newcommand*\usestorebox[1]{%
    \mbox{\pdfrefxform#1}%
}
%    \end{macrocode}
% \end{macro}
%
%
%    \begin{macrocode}
\else
%    \end{macrocode}
%
%
% \begin{macro}{\@storebox}
% Macro version:
%    \begin{macrocode}
\def\@storebox#1{\@collectboxto{#1}{}}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@storebox@env}
%    \begin{macrocode}
\def\@storebox@env{%
  \edef\@currenvir{\@currenvir\noexpand\noexpand\noexpand\empty}%
  \lrbox
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\endstorebox}
%    \begin{macrocode}
\def\endstorebox{%
    \endlrbox
    \edef\@currenvir{\@currenvir}%
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\newsavebox}
%    \begin{macrocode}
\@ifdefinable\newstorebox{%
\let\newstorebox\newsavebox
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\usestorebox}
%    \begin{macrocode}
\@ifdefinable\usestorebox{%
\let\usestorebox\usebox
}
%    \end{macrocode}
% \end{macro}
%
%    \begin{macrocode}
\fi
%    \end{macrocode}
%

