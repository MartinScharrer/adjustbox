%    \begin{macrocode}
%<!COPYRIGHT>
\ProvidesFile{tc-xetex.def}[2012/05/13 v1.0 Clipping driver for xetex]
%    \end{macrocode}
%
% \begin{macro}{\@cliptoboxdim}
% Clips to official box dimension.
%
% The following clipping code was suggested by
% Joseph Wright (LaTeX3 project), but slightly modified
% for this package.
%    \begin{macrocode}
\def\@cliptoboxdim#1{%
    \setbox#1=\hbox{%
        \Gin@defaultbp\WIDTH{\wd#1}%
        \Gin@defaultbp\DEPTH{\dp#1}%
        \@tempdima\ht#1%
        \advance\@tempdima\dp#1%
        \Gin@defaultbp\TOTALHEIGHT{\@tempdima}%
        \special{pdf:content q }%
        \special{%
            pdf:code
                0 -\DEPTH\space \WIDTH\space \TOTALHEIGHT\space re W n
        }%
        \special{pdf:literal direct -1 0 0 -1 0 0 cm }%
        \special{pdf:content q }%
        \special{pdf:literal direct -1 0 0 -1 0 0 cm }%
        \hbox to 0 pt{\copy#1\hss}%
        \special{pdf:content Q }%
        \special{pdf:content Q }%
        \hskip\wd#1%
    }%
}


%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@cliptoboxdim}
% Clips round corners off.
%    \begin{macrocode}
\def\@clipcornersofbox#1#2#3#4#5{%
    \setbox#1=\hbox{%
        \def\calcbp##1##2{%
            \adjsetlength\@tempdima{##2}%
            \Gin@defaultbp##1\@tempdima%
        }%
        \calcbp\TOTALHEIGHT{\ht#1+\dp#1}%
        \Gin@defaultbp\HEIGHT{\ht#1}%
        \Gin@defaultbp\DEPTH{-\dp#1}%
        \Gin@defaultbp\WIDTH{\wd#1}%
        \Gin@defaultbp\RADIUSTL{#2}%
        \Gin@defaultbp\RADIUSTR{#3}%
        \Gin@defaultbp\RADIUSBR{#4}%
        \Gin@defaultbp\RADIUSBL{#5}%
        \def\bezfac{0.55228475}%
        \def\bezfacn{0.44771525}%
        \Gin@defaultbp\RADIUSTLb{\bezfacn#2}%
        %
        \calcbp\HEIGHTmRADIUSTL{\ht#1-#2}%
        \calcbp\HEIGHTmRADIUSTLb{\ht#1-\bezfacn#2}%
        \calcbp\HEIGHTmRADIUSTR{\ht#1-#3}%
        \calcbp\HEIGHTmRADIUSTRb{\ht#1-\bezfacn#3}%
        \calcbp\WIDTHmRADIUSTR{\wd#1-#3}%
        \calcbp\WIDTHmRADIUSTRb{\wd#1-\bezfacn#3}%
        \calcbp\RADIUSBRmDEPTH{#4-\dp#1}%
        \calcbp\RADIUSBRmDEPTHb{\bezfacn#4-\dp#1}%
        \calcbp\WIDTHmRADIUSBR{\wd#1-#4}%
        \calcbp\WIDTHmRADIUSBRb{\wd#1-\bezfacn#4}%
        \calcbp\RADIUSBLmDEPTH{#5-\dp#1}%
        \calcbp\RADIUSBLmDEPTHb{\bezfacn#5-\dp#1}%
        \calcbp\RADIUSBLb{\bezfacn#5}%

        \special{pdf:content q }%
              \special{pdf:code 0 \HEIGHTmRADIUSTL\space m }%
              \special{pdf:code 0 \HEIGHTmRADIUSTLb\space \RADIUSTLb\space \HEIGHT\space \RADIUSTL\space \HEIGHT\space c }%
              \special{pdf:code \WIDTHmRADIUSTR\space \HEIGHT\space l }%
              \special{pdf:code \WIDTHmRADIUSTRb\space \HEIGHT\space \WIDTH\space \HEIGHTmRADIUSTRb\space \WIDTH\space \HEIGHTmRADIUSTR\space c }%
              \special{pdf:code \WIDTH\space \RADIUSBRmDEPTH\space l }%
              \special{pdf:code \WIDTH\space \RADIUSBRmDEPTHb\space \WIDTHmRADIUSBRb\space \DEPTH\space \WIDTHmRADIUSBR\space \DEPTH\space c }%
              \special{pdf:code \RADIUSBL\space \DEPTH\space l }%
              \special{pdf:code \RADIUSBLb\space \DEPTH\space 0 \RADIUSBLmDEPTHb\space 0 \RADIUSBLmDEPTH\space c }%
              \special{pdf:code 0 \RADIUSBLmDEPTH\space l }%
              \special{pdf:code h }%
              \special{pdf:code W }%
              \special{pdf:code n }%
        \special{pdf:literal direct -1 0 0 -1 0 0 cm }%
        \special{pdf:content q }%
        \special{pdf:literal direct -1 0 0 -1 0 0 cm }%
        \hbox to 0 pt{\copy#1\hss}%
        \special{pdf:content Q }%
        \special{pdf:content Q }%
        \hskip\wd#1%
    }%
}
%    \end{macrocode}
% \end{macro}
%
%^^A vim: ft=tex
